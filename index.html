import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Menu, X, Volume2, VolumeX, ChevronRight, ChevronLeft, Play, Pause, Info, Phone, Mail, ExternalLink, Triangle } from "lucide-react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Toaster } from "@/components/ui/sonner";
import { toast } from "sonner";
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip as RTooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  Cell,
} from "recharts";

// ========
// Single-file React App for "إيماني" (Desktop + Mobile)
// - RTL, Tailwind CSS, shadcn/ui, framer-motion, recharts
// - In-app routing via state (no external router)
// - Mobile-ready and Web-ready. For mobile packaging use Capacitor/Cordova WebView.
// - All strings are Arabic and UI flows match user's spec.
// ========

// Utility: join class names
function cn(...a) { return a.filter(Boolean).join(" "); }

// Palette
const palette = {
  bg: "from-[#0f6781] via-[#2a7c92] to-[#d7c7a1]",
  blue: "#2a7c92",
  beige: "#f3ead8",
  gold: "#d4a944",
  text: "#0f2a32",
};

// App routes
const routes = [
  { key: "home", label: "الرئيسية" },
  { key: "vision", label: "الارتباط برؤية 2030" },
  { key: "assessment", label: "التقييم" },
  { key: "results", label: "النتائج" },
  { key: "partners", label: "شركاؤنا" },
  { key: "contact", label: "تواصل معنا" },
];

// Vision 2030 goals (strategic -> sub -> final) based on user's table
const VISION = [
  {
    icon: "🕊️",
    title: "تعزيز القيم الإسلامية والهوية الوطنية",
    subs: [
      "تعزيز قيم الوسطية والتسامح",
      "تعزيز قيم الإتقان والانضباط",
      "تعزيز قيم العدالة والشفافية",
      "تعزيز قيم العزيمة والمثابرة",
    ],
    final: "ترسيخ الإيمان والهوية الإيجابية في سلوك الفرد والمجتمع.",
  },
  {
    icon: "💫",
    title: "تمكين حياة عامرة وصحية",
    subs: [
      "تعزيز نمط حياة صحي",
      "الارتقاء بجودة الحياة في المدن",
      "تعزيز الوقاية من المخاطر الصحية",
      "دعم الثقافة والترفيه",
    ],
    final: "مجتمع متوازن يعيش حياة صحية وروحية متكاملة.",
  },
  {
    icon: "🤝",
    title: "تمكين المسؤولية الاجتماعية",
    subs: [
      "تعزيز قيام الأفراد والشركات بدورهم المجتمعي",
      "تمكين المنظمات غير الربحية لتحقيق أثر أعمق",
    ],
    final: "مجتمع متكافل يشارك بفاعلية في التنمية المستدامة.",
  },
];

// Hawkins scale (selected levels) for visualization
const hawkinsLevels = [
  { name: "خزي", value: 20 },
  { name: "حزن", value: 75 },
  { name: "خوف", value: 100 },
  { name: "غضب", value: 150 },
  { name: "شجاعة", value: 200 },
  { name: "استعداد", value: 310 },
  { name: "قبول", value: 350 },
  { name: "محبة", value: 500 },
  { name: "فرح", value: 540 },
  { name: "سلام", value: 600 },
];

const maslow = [
  { name: "فيسيولوجي", value: 1 },
  { name: "أمان", value: 2 },
  { name: "انتماء", value: 3 },
  { name: "تقدير", value: 4 },
  { name: "تحقيق ذات", value: 5 },
];

// Simple partner list (placeholders)
const partners = [
  { name: "رؤية 2030", logo: "VISION2030" },
  { name: "تلبية للبحث والتطوير", logo: "TELBIYA" },
  { name: "جامعة حائل", logo: "UOH" },
  { name: "غرفة حائل", logo: "HCCI" },
];

export default function ImaniApp() {
  const [route, setRoute] = useState("home");
  const [openMenu, setOpenMenu] = useState(false);
  const [playing, setPlaying] = useState(true);
  const audioRef = useRef(null);

  // Assessment state (sliders 1..5)
  const [answers, setAnswers] = useState({
    حضور_الذكر: 0,
    التفكر: 0,
    التوكل: 0,
    الصبر: 0,
    الشكر: 0,
  });

  const answered = useMemo(() => Object.values(answers).some((v) => v > 0), [answers]);

  useEffect(() => {
    if (audioRef.current) {
      try {
        if (playing) audioRef.current.play().catch(() => {});
        else audioRef.current.pause();
      } catch (e) {}
    }
  }, [playing]);

  useEffect(() => {
    // Close drawer on route change
    setOpenMenu(false);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, [route]);

  return (
    <div dir="rtl" className="min-h-screen bg-gradient-to-b from-[#0f6781] to-[#e9dec7] text-[#{palette.text}] text-slate-900 selection:bg-yellow-200/60">
      {/* Top Wave / Hero BG */}
      <header className="sticky top-0 z-50 backdrop-blur bg-white/70 border-b border-white/40">
        <div className="container mx-auto px-4 py-3 flex items-center justify-between">
          {/* Right: Imani Logo */}
          <div className="flex items-center gap-2">
            <div className="w-10 h-10 rounded-2xl bg-[#0f6781] text-white grid place-items-center font-semibold">إ</div>
            <span className="font-extrabold text-xl tracking-tight">إيماني</span>
          </div>

          {/* Center: Nav */}
          <nav className="hidden md:flex gap-6 text-sm font-medium">
            {routes.map((r) => (
              <button
                key={r.key}
                onClick={() => setRoute(r.key)}
                className={cn(
                  "px-3 py-2 rounded-xl transition",
                  route === r.key ? "bg-[#d4a944]/15 text-[#0f6781]" : "hover:bg-slate-100"
                )}
              >
                {r.label}
              </button>
            ))}
          </nav>

          {/* Left: Logos + Audio */}
          <div className="flex items-center gap-3">
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger asChild>
                  <Button size="icon" variant="ghost" onClick={() => setPlaying((p) => !p)} aria-label="تشغيل/إيقاف التلاوة">
                    {playing ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
                  </Button>
                </TooltipTrigger>
                <TooltipContent>تلاوة عبدالباسط (هادئة)</TooltipContent>
              </Tooltip>
            </TooltipProvider>

            <div className="hidden sm:flex items-center gap-2">
              {/* Vision 2030 */}
              <span className="px-2 py-1 rounded-md border text-xs">رؤية 2030</span>
              {/* Telbiya */}
              <span className="px-2 py-1 rounded-md border text-xs">تلبية</span>
            </div>

            {/* Mobile menu */}
            <Button className="md:hidden" variant="ghost" size="icon" onClick={() => setOpenMenu((o) => !o)}>
              {openMenu ? <X /> : <Menu />}
            </Button>
          </div>
        </div>

        {/* Mobile drawer */}
        <AnimatePresence>
          {openMenu && (
            <motion.div
              initial={{ height: 0 }}
              animate={{ height: "auto" }}
              exit={{ height: 0 }}
              className="md:hidden border-t bg-white/80 backdrop-blur"
            >
              <div className="px-4 py-3 grid gap-2">
                {routes.map((r) => (
                  <Button key={r.key} variant={route === r.key ? "secondary" : "ghost"} className="justify-start" onClick={() => setRoute(r.key)}>
                    {r.label}
                  </Button>
                ))}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </header>

      {/* Hidden audio element */}
      <audio ref={audioRef} loop autoPlay muted={!playing} className="hidden">
        {/* You can replace the src with an actual hosted MP3 of Abdulbasit recitation */}
        <source src="" type="audio/mpeg" />
      </audio>

      <main className="container mx-auto px-4 pb-20">
        <AnimatePresence mode="wait">
          {route === "home" && <Home onStart={() => setRoute("assessment")} />}
          {route === "vision" && <Vision2030 />}
          {route === "assessment" && (
            <Assessment answers={answers} setAnswers={setAnswers} onNext={() => setRoute("results")} />
          )}
          {route === "results" && (
            <Results answers={answers} onBack={() => setRoute("assessment")} onPartners={() => setRoute("partners")} />
          )}
          {route === "partners" && <Partners />}
          {route === "contact" && <Contact />}
        </AnimatePresence>
      </main>

      {/* Footer */}
      <footer className="border-t bg-white/70 backdrop-blur">
        <div className="container mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between gap-3 text-sm">
          <div className="flex items-center gap-2">
            <span className="font-bold">إيماني</span>
            <span className="text-slate-500">— منصة وعي إيماني معاصر</span>
          </div>
          <div className="text-slate-600">© جميع الحقوق محفوظة لشركة تلبية للبحث والتطوير</div>
        </div>
      </footer>

      <Toaster richColors closeButton />
    </div>
  );
}

function Section({ children, className }) {
  return (
    <section className={cn("my-10 md:my-14", className)}>
      {children}
    </section>
  );
}

function Home({ onStart }) {
  return (
    <motion.div key="home" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      {/* Hero */}
      <Section className="pt-6">
        <div className="rounded-3xl overflow-hidden bg-gradient-to-br from-[#0f6781] via-[#2a7c92] to-[#d4a944]/40 text-white">
          <div className="px-6 md:px-12 py-16 md:py-24 text-center">
            <h1 className="text-3xl md:text-5xl font-black leading-relaxed">ابدأ رحلتك نحو معرفة نفسك من خلال أسماء الله الحسنى</h1>
            <p className="mt-4 text-white/90 max-w-2xl mx-auto">
              مساحة إيمانية عملية تساعدك على الوعي بذاتك، وتحسين سلوكك اليومي، وخلق اتساق روحي مع معاني الأسماء الحسنى.
            </p>
            <div className="mt-8">
              <Button size="lg" className="bg-[#d4a944] text-[#0f2a32] hover:bg-[#c79b34] font-extrabold px-8 rounded-xl" onClick={onStart}>
                ابدأ التقييم الآن
              </Button>
            </div>
            <div className="mt-10 text-2xl font-semibold text-white/90">
              ما ظَنُّكُم بِرَبِّ العَالَمِينَ
            </div>
          </div>
        </div>
      </Section>

      {/* About */}
      <Section>
        <div className="grid md:grid-cols-2 gap-6 items-stretch">
          <Card className="rounded-2xl shadow-sm">
            <CardHeader>
              <CardTitle>عن المنصة</CardTitle>
            </CardHeader>
            <CardContent className="text-slate-700 leading-8">
              منصة إيماني تمزج بين الروحانية والحداثة لتقوية الوعي الذاتي عبر أدوات تقييم ونتائج عملية تربط قيم الإيمان بسلوك الحياة اليومية.
            </CardContent>
          </Card>
          <div className="grid grid-cols-2 gap-4">
            {["الإيمان", "التوازن", "الوعي", "النمو"].map((t, i) => (
              <Card key={i} className="rounded-2xl grid place-items-center py-8">
                <div className="text-xl font-bold">{t}</div>
              </Card>
            ))}
          </div>
        </div>
      </Section>

      {/* Quick cards */}
      <Section>
        <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          {[{ k: "assessment", t: "التقييم الذاتي" }, { k: "results", t: "النتائج" }, { k: "partners", t: "شركاؤنا" }, { k: "programs", t: "البرامج الإيمانية" }].map((c) => (
            <Card key={c.k} className="rounded-2xl hover:shadow-md transition">
              <CardContent className="py-8 text-center font-semibold">{c.t}</CardContent>
            </Card>
          ))}
        </div>
      </Section>
    </motion.div>
  );
}

function Vision2030() {
  return (
    <motion.div key="vision" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      <Section>
        <div className="rounded-3xl bg-gradient-to-br from-[#e9dec7] to-white p-6 md:p-10 border">
          <h2 className="text-2xl md:text-3xl font-extrabold text-[#0f2a32] mb-2">الارتباط برؤية 2030</h2>
          <p className="text-slate-700">منصة إيماني تُجسّد مستهدفات الرؤية عبر ثلاثة محاور استراتيجية:</p>

          <div className="grid md:grid-cols-3 gap-6 mt-6">
            {VISION.map((v, idx) => (
              <Card key={idx} className="rounded-2xl">
                <CardHeader>
                  <CardTitle className="flex items-center justify-between">
                    <span className="text-xl font-bold">{v.title}</span>
                    <span className="text-2xl" aria-hidden>{v.icon}</span>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <ul className="list-disc pr-5 leading-8 text-slate-700">
                    {v.subs.map((s, i) => (
                      <li key={i}>{s}</li>
                    ))}
                  </ul>
                  <div className="mt-4 p-3 rounded-xl bg-amber-50 border text-amber-900 text-sm">{v.final}</div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </Section>

      {/* Integration map */}
      <Section>
        <Card className="rounded-2xl">
          <CardHeader>
            <CardTitle>كيف ترتبط مكونات المنصة بمحاور الرؤية؟</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid md:grid-cols-3 gap-4 text-sm">
              <div className="p-4 rounded-xl bg-sky-50 border">التقييم الذاتي → يعزز القيم الإسلامية</div>
              <div className="p-4 rounded-xl bg-emerald-50 border">نتائج الوعي والمتابعة → تدعم جودة الحياة</div>
              <div className="p-4 rounded-xl bg-amber-50 border">المشاركة المجتمعية وبرامج الشراكة → تمكّن المسؤولية الاجتماعية</div>
            </div>
          </CardContent>
        </Card>
      </Section>
    </motion.div>
  );
}

function Slider({ label, value, onChange }) {
  return (
    <div className="grid gap-2">
      <div className="flex items-center justify-between">
        <div className="font-medium">{label}</div>
        <div className="text-xs text-slate-500">{value}</div>
      </div>
      <input
        type="range"
        min={0}
        max={5}
        step={1}
        value={value}
        onChange={(e) => onChange(+e.target.value)}
        className="w-full accent-[#d4a944]"
      />
      <div className="flex justify-between text-xs text-slate-500"><span>0</span><span>5</span></div>
    </div>
  );
}

function Assessment({ answers, setAnswers, onNext }) {
  const setVal = (k, v) => setAnswers((s) => ({ ...s, [k]: v }));

  return (
    <motion.div key="assessment" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      <Section>
        <div className="rounded-3xl overflow-hidden border bg-white">
          <div className="px-6 md:px-10 py-8 bg-gradient-to-r from-[#e9dec7] to-white">
            <h2 className="text-2xl md:text-3xl font-extrabold text-[#0f2a32] mb-2">التقييم الذاتي</h2>
            <p className="text-slate-700">أجب عن المؤشرات الخمسة أدناه بصدق. لن تظهر النتائج قبل بدء التقييم.</p>
          </div>

          <div className="p-6 grid md:grid-cols-2 gap-6">
            {Object.entries(answers).map(([k, v]) => (
              <Slider key={k} label={k.replaceAll("_", " ")} value={v} onChange={(val) => setVal(k, val)} />
            ))}
          </div>

          <div className="px-6 pb-8 flex items-center gap-3">
            <Button className="bg-[#0f6781] hover:bg-[#0d566b]" onClick={() => {
              const started = Object.values(answers).some((v) => v > 0);
              if (!started) {
                toast.warning("يجب البدء بتحريك المؤشرات قبل استعراض النتائج.");
                return;
              }
              onNext();
            }}>
              استعراض النتائج
            </Button>
            <Dialog>
              <DialogTrigger asChild>
                <Button variant="ghost" className="gap-2"><Info className="w-4 h-4" /> كيف يعمل التقييم؟</Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>آلية التقييم</DialogTitle>
                </DialogHeader>
                <div className="space-y-3 text-slate-700 leading-7">
                  <p>حرّك كل مؤشر من 0 إلى 5 بحسب واقعك الحالي. تحت الغطاء نقوم بحساب درجة وعي مركبة ونربطها بمستويات هاوكنز وطبقات ماسلو. يمكنك إعادة التقييم لاحقًا للمقارنة.</p>
                </div>
              </DialogContent>
            </Dialog>
          </div>
        </div>
      </Section>
    </motion.div>
  );
}

function Results({ answers, onBack, onPartners }) {
  const started = Object.values(answers).some((v) => v > 0);
  const score = useMemo(() => {
    const vals = Object.values(answers);
    const s = vals.reduce((a, b) => a + b, 0);
    return Math.round((s / (vals.length * 5)) * 100);
  }, [answers]);

  // Map to an approximate Hawkins level
  const hawkinsIndex = useMemo(() => {
    const idx = Math.min(hawkinsLevels.length - 1, Math.floor((score / 100) * (hawkinsLevels.length - 1)));
    return idx;
  }, [score]);

  // Maslow layer suggestion
  const maslowLevel = useMemo(() => {
    if (score < 20) return 1; // physiological
    if (score < 40) return 2; // safety
    if (score < 60) return 3; // love/belonging
    if (score < 80) return 4; // esteem
    return 5; // self-actualization
  }, [score]);

  useEffect(() => {
    if (!started) toast.info("ابدأ بتحريك المؤشرات في صفحة التقييم أولًا.");
  }, [started]);

  return (
    <motion.div key="results" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      <Section>
        <div className="rounded-3xl border overflow-hidden">
          <div className="px-6 md:px-10 py-8 bg-gradient-to-r from-[#e9dec7] to-white">
            <h2 className="text-2xl md:text-3xl font-extrabold text-[#0f2a32] mb-2">النتائج</h2>
            <p className="text-slate-700">سُلّم هاوكنز وهرم ماسلو بصريًا وتحليل موجز.</p>
          </div>

          <div className="p-6 grid lg:grid-cols-2 gap-8">
            {/* Hawkins area chart */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>موضعك التقريبي على سُلّم هاوكنز</CardTitle>
              </CardHeader>
              <CardContent style={{ height: 320 }}>
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={hawkinsLevels} margin={{ top: 10, right: 20, left: 0, bottom: 0 }}>
                    <defs>
                      <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stopColor="#d4a944" stopOpacity={0.8} />
                        <stop offset="100%" stopColor="#2a7c92" stopOpacity={0.2} />
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis domain={[0, 600]} />
                    <RTooltip />
                    <Area type="monotone" dataKey="value" stroke="#0f6781" fill="url(#g)" />
                  </AreaChart>
                </ResponsiveContainer>
                <div className="mt-3 text-sm text-slate-600">درجتك الإجمالية: <b>{score}</b> / 100 — أقرب مستوى: <b>{hawkinsLevels[hawkinsIndex].name}</b>.</div>
              </CardContent>
            </Card>

            {/* Maslow pyramid (bar chart ascending) */}
            <Card className="rounded-2xl">
              <CardHeader>
                <CardTitle>موضعك في هرم ماسلو</CardTitle>
              </CardHeader>
              <CardContent style={{ height: 320 }}>
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={maslow} layout="vertical" margin={{ top: 10, right: 20, left: 0, bottom: 0 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis type="number" domain={[0, 5]} hide />
                    <YAxis type="category" dataKey="name" width={80} />
                    <RTooltip />
                    <Bar dataKey="value">
                      {maslow.map((entry, index) => (
                        <Cell key={`c-${index}`} fill={index + 1 <= maslowLevel ? "#d4a944" : "#e9dec7"} />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
                <div className="mt-3 text-sm text-slate-600">مستواك الحالي المقترح: <b>{maslow.find((m) => m.value === maslowLevel)?.name}</b>.</div>
              </CardContent>
            </Card>
          </div>

          {/* Narrative */}
          <div className="px-6 pb-8 text-slate-700 leading-8">
            <p>
              التحليل الموجز: تعكس الدرجة توازنًا عامًا في مؤشرات (الذكر، التفكر، التوكل، الصبر، الشكر). ننصح بالاستمرار على خطة أسبوعية
              صغيرة قابلة للقياس لرفع مستوى الوعي العاطفي والسلوكي.
            </p>
            <div className="mt-4 flex flex-wrap gap-3">
              <Button variant="outline" onClick={onBack}><ChevronRight className="w-4 h-4" /> العودة للتقييم</Button>
              <Button className="bg-[#0f6781] hover:bg-[#0d566b]" onClick={onPartners}>استكشاف شركاؤنا</Button>
            </div>
          </div>
        </div>
      </Section>
    </motion.div>
  );
}

function Partners() {
  return (
    <motion.div key="partners" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      <Section>
        <div className="rounded-3xl border p-6 md:p-10 bg-white">
          <h2 className="text-2xl md:text-3xl font-extrabold text-[#0f2a32] mb-2">شركاؤنا</h2>
          <p className="text-slate-700">نماذج لشعارات شركاء داعمين للمنصة. يمكن ربط كل شعار بصفحة الشريك.</p>
          <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mt-6">
            {partners.map((p) => (
              <div key={p.name} className="h-20 rounded-xl border grid place-items-center text-xs sm:text-sm font-bold text-slate-500">
                {p.logo}
              </div>
            ))}
          </div>
        </div>
      </Section>
    </motion.div>
  );
}

function Contact() {
  return (
    <motion.div key="contact" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }}>
      <Section>
        <div className="rounded-3xl border overflow-hidden">
          <div className="px-6 md:px-10 py-8 bg-gradient-to-r from-[#e9dec7] to-white">
            <h2 className="text-2xl md:text-3xl font-extrabold text-[#0f2a32] mb-2">تواصل معنا</h2>
            <p className="text-slate-700">نسعد برسالتك واقتراحاتك.</p>
          </div>
          <div className="p-6 grid md:grid-cols-2 gap-6 items-start">
            <div className="grid gap-3">
              <Input placeholder="الاسم" />
              <Input type="email" placeholder="البريد الإلكتروني" />
              <Textarea rows={6} placeholder="نص الرسالة" />
              <Button className="bg-[#0f6781] hover:bg-[#0d566b]">إرسال</Button>
            </div>
            <div className="text-slate-600 text-sm leading-7">
              <div className="flex items-center gap-2"><Phone className="w-4 h-4" /> 0000 000 555</div>
              <div className="flex items-center gap-2"><Mail className="w-4 h-4" /> contact@imani.sa</div>
            </div>
          </div>
        </div>
      </Section>
    </motion.div>
  );
}
